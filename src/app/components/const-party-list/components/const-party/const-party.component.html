<div class="detail">
  <div class="leader-card" *ngIf="leaders().length">
    <div class="section-title">Лидер</div>
    <div class="leader-row" *ngFor="let l of leaders()">
      <div class="leader-left">
        <p-tag value="PL" [severity]="'info'" class="dark:!bg-surface-900"></p-tag>
        <div class="leader-name">{{ l.name }}</div>
      </div>

      <div class="row-actions">
        <p-button
          type="button"
          icon="pi pi-pencil"
          [rounded]="true"
          [text]="true"
          ariaLabel="Редактировать"
          (onClick)="startEdit(l)"
        ></p-button>
        <p-button
          type="button"
          icon="pi pi-trash"
          [rounded]="true"
          [text]="true"
          [severity]="'danger'"
          ariaLabel="Удалить"
          (onClick)="confirmDeleteUser(l)"
        ></p-button>
      </div>
    </div>
  </div>

  <div class="users-header">
    <div class="section-title">Пользователи</div>
    <div class="users-actions" *ngIf="!showAddForm()">
      <p-button
        type="button"
        icon="pi pi-plus"
        label="Добавить"
        [rounded]="true"
        [text]="true"
        ariaLabel="Добавить участника"
        (onClick)="showAddForm.set(true)"
      ></p-button>
    </div>
  </div>

  <p-table [value]="allUsers()" [rowHover]="true" [scrollable]="true" scrollHeight="flex">
    <ng-template pTemplate="header">
      <tr>
        <th>Имя</th>
        <th style="width: 260px">Роль</th>
        <th style="width: 160px" class="text-left">Действия</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-u>
      <tr>
        <td>
          <div class="user-name">{{ u.name }}</div>
        </td>
        <td>
          <ng-container *ngIf="(u.role ?? '').toLowerCase() === 'leader'; else normalRole">
            <p-tag value="PL" [severity]="'info'" class="dark:!bg-surface-900"></p-tag>
          </ng-container>
          <ng-template #normalRole>
            <span class="text-muted">{{ displayRole(u) ?? '—' }}</span>
          </ng-template>
        </td>
        <td class="text-left">
          <div class="row-actions">
            <p-button
              type="button"
              icon="pi pi-pencil"
              [rounded]="true"
              [text]="true"
              ariaLabel="Редактировать"
              (onClick)="startEdit(u)"
            ></p-button>
            <p-button
              type="button"
              icon="pi pi-trash"
              [rounded]="true"
              [text]="true"
              [severity]="'danger'"
              ariaLabel="Удалить"
              (onClick)="confirmDeleteUser(u)"
            ></p-button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="3" class="text-center text-muted p-4">Пока никого нет</td>
      </tr>
    </ng-template>
  </p-table>

  <form *ngIf="showAddForm()" class="add-form" [formGroup]="addForm" (ngSubmit)="addUser()">
    <div class="field">
      <label for="userName">Имя</label>
      <input id="userName" pInputText formControlName="name" />
    </div>

    <div class="field">
      <label for="userRole">Роль</label>
      <p-dropdown
        inputId="userRole"
        [options]="roleOptions"
        optionLabel="label"
        optionValue="value"
        formControlName="role"
        [appendTo]="'body'"
        [showClear]="false"
      ></p-dropdown>
    </div>

    <div class="buttons">
      <p-button type="submit" label="Добавить" [loading]="isAdding()" [disabled]="isAdding()"></p-button>
      <p-button type="button" label="Отмена" [text]="true" [severity]="'secondary'" (onClick)="cancelAdd()"></p-button>
    </div>
  </form>

  <div class="edit-panel" *ngIf="editingUser() as editing">
    <div class="section-title">Редактирование</div>
    <form class="edit-form" [formGroup]="editForm" (ngSubmit)="saveEdit()">
      <div class="field">
        <label for="editName">Имя</label>
        <input id="editName" pInputText formControlName="name" />
      </div>

      <div class="field">
        <label for="editRole">Роль</label>
        <p-dropdown
          inputId="editRole"
          [options]="roleOptions"
          optionLabel="label"
          optionValue="value"
          formControlName="role"
          [appendTo]="'body'"
          [showClear]="false"
        ></p-dropdown>
      </div>

      <div class="row-actions">
        <p-button
          type="submit"
          icon="pi pi-check"
          [rounded]="true"
          [text]="true"
          ariaLabel="Сохранить"
          [loading]="isEditing()"
          [disabled]="isEditing()"
        ></p-button>
        <p-button
          type="button"
          icon="pi pi-times"
          [rounded]="true"
          [text]="true"
          [severity]="'secondary'"
          ariaLabel="Отмена"
          (onClick)="cancelEdit()"
        ></p-button>
      </div>
    </form>
  </div>
</div>
