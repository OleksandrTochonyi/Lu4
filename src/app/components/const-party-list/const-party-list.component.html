<div class="party-page">
    <p-confirmDialog></p-confirmDialog>

    <div class="party-shell flex flex-col h-full border border-surface rounded bg-surface-0 dark:bg-surface-900 overflow-hidden">
        <div class="party-header border-b">
            <div class="party-title-row">
                <div class="party-title">Список всех пачек Shaders</div>

                <button
                    type="button"
                    pButton
                    icon="pi pi-info-circle"
                    class="info-btn p-button-text p-button-secondary"
                    (mouseenter)="showInfo($event, infoPanel)"
                    (mouseleave)="scheduleHideInfo(infoPanel)"
                    (focus)="showInfo($event, infoPanel)"
                    (blur)="scheduleHideInfo(infoPanel)"
                    aria-label="Информация"
                ></button>

                <p-overlayPanel #infoPanel styleClass="info-popover" [dismissable]="false" [showCloseIcon]="false">
                    <div class="info-content" (mouseenter)="cancelHideInfo()" (mouseleave)="scheduleHideInfo(infoPanel)">
                        <div class="info-row">
                            <span>Количество паков</span>
                            <p-badge [value]="groupCount()" [severity]="'secondary'"></p-badge>
                        </div>
                        <div class="info-row">
                            <span>Количество человек</span>
                            <p-badge [value]="peopleCount()" [severity]="'secondary'"></p-badge>
                        </div>
                    </div>
                </p-overlayPanel>
            </div>

        </div>

        <div class="party-content">
        <form *ngIf="showCreateForm()" class="create-form" [formGroup]="createForm" (ngSubmit)="createGroup()">
            <div class="field">
                <label for="displayName">Название группы</label>
                <input id="displayName" pInputText formControlName="displayName" />
            </div>

            <div class="field">
                <label for="leaderName">Лидер (имя)</label>
                <input id="leaderName" pInputText formControlName="leaderName" />
            </div>

            <div class="buttons">
                <p-button type="submit" label="Создать" [loading]="isCreating()" [disabled]="isCreating()"></p-button>
                <p-button type="button" label="Отмена" [text]="true" [severity]="'secondary'"
                    (onClick)="cancelCreate()"></p-button>
            </div>
        </form>

        <div class="master-detail">
            <div class="master-pane">
                <div class="group-list">
                    <button
                        type="button"
                        class="group-tab"
                        *ngFor="let group of sortedGroups(); trackBy: trackByGroupId"
                        [class.group-tab--active]="selectedGroupId() === group.id"
                        (click)="selectGroup(group)"
                        role="tab"
                        [attr.aria-selected]="selectedGroupId() === group.id"
                    >
                        <div class="group-tab-main">
                            <span class="group-name">{{ group.displayName }}</span>
                            <p-badge class="group-badge" [value]="group.users.length" [severity]="'secondary'"></p-badge>
                        </div>
                    </button>

                    <div class="empty" *ngIf="sortedGroups().length === 0">Пока нет групп</div>

                    <button
                        *ngIf="!showCreateForm()"
                        type="button"
                        class="group-tab group-tab--create"
                        (click)="showCreateForm.set(true)"
                        aria-label="Добавить группу"
                    >
                        <div class="group-tab-main">
                            <i class="pi pi-plus" aria-hidden="true"></i>
                            <span class="group-name">Добавить группу</span>
                        </div>
                    </button>
                </div>
            </div>

            <div class="detail-pane">
                <ng-container *ngIf="selectedGroup() as group; else emptyState">
                    <div class="detail-header">
                        <div class="detail-title">
                            <div class="detail-left">
                                <div class="detail-name" *ngIf="editingGroupId() !== group.id">{{ group.displayName }}</div>
                                <input
                                    *ngIf="editingGroupId() === group.id"
                                    type="text"
                                    pInputText
                                    class="detail-edit"
                                    [formControl]="editGroupForm.controls.displayName"
                                    (keydown.enter)="$event.preventDefault(); saveGroup(group)"
                                />

                                <div class="detail-meta">
                                    <span class="detail-meta-item">Участников:</span>
                                    <p-badge [value]="group.users.length" [severity]="'secondary'"></p-badge>
                                </div>
                            </div>

                            <div class="detail-actions">
                                <ng-container *ngIf="editingGroupId() === group.id; else viewGroupActions">
                                    <p-button
                                        type="button"
                                        icon="pi pi-check"
                                        [rounded]="true"
                                        [text]="true"
                                        ariaLabel="Сохранить"
                                        [loading]="isGroupSaving()"
                                        [disabled]="isGroupSaving()"
                                        (onClick)="saveGroup(group)"
                                    ></p-button>

                                    <p-button
                                        type="button"
                                        icon="pi pi-times"
                                        [rounded]="true"
                                        [text]="true"
                                        [severity]="'secondary'"
                                        ariaLabel="Отмена"
                                        (onClick)="cancelEditGroup()"
                                    ></p-button>
                                </ng-container>

                                <ng-template #viewGroupActions>
                                    <p-button
                                        type="button"
                                        icon="pi pi-pencil"
                                        [rounded]="true"
                                        [text]="true"
                                        styleClass="detail-action detail-action--edit"
                                        ariaLabel="Редактировать группу"
                                        (onClick)="startEditGroup(group)"
                                    ></p-button>

                                    <p-button
                                        type="button"
                                        icon="pi pi-trash"
                                        [rounded]="true"
                                        [text]="true"
                                        styleClass="detail-action detail-action--delete"
                                        ariaLabel="Удалить группу"
                                        (onClick)="confirmDeleteGroup(group)"
                                    ></p-button>
                                </ng-template>
                            </div>
                        </div>
                    </div>

                    <app-const-party [group]="group"></app-const-party>
                </ng-container>

                <ng-template #emptyState>
                    <div class="empty">Выберите группу слева</div>
                </ng-template>
            </div>
        </div>
        </div>
    </div>
</div>